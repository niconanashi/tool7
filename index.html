<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Audio Converter</title>
    <!-- セキュリティ解除スクリプト -->
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 50px; background: #f0f4f8; }
        .box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; width: 80%; max-width: 500px; }
        #drop-zone { border: 3px dashed #aaa; border-radius: 10px; padding: 40px 20px; cursor: pointer; }
        #status { margin-top: 20px; font-weight: bold; }
        #download-btn { margin-top: 20px; padding: 12px 24px; cursor: pointer; display: none; background: #28a745; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h1>音声変換 (AAC & OGG)</h1>
    <div id="drop-zone">ここに音声をドロップ</div>
    <div id="status">設定を確認中...</div>
    <button id="download-btn">ZIPファイルを保存</button>
</div>

<script type="module">
    import { FFmpeg } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/esm/index.js';
    import { fetchFile, toBlobURL } from 'https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js';

    const ffmpeg = new FFmpeg();
    const status = document.getElementById('status');
    const downloadBtn = document.getElementById('download-btn');

    async function init() {
        // セキュリティチェック（coi-serviceworkerが動いているか）
        if (!self.crossOriginIsolated) {
            status.innerHTML = "初期化中... 自動でリロードされます。<br>されない場合は手動で更新してください。";
            return;
        }

        try {
            status.innerText = "FFmpegをロード中...";

            // 【重要】GitHub Pagesの絶対パスを計算
            const loc = window.location.origin + window.location.pathname.replace('index.html', '');
            
            // 全てのパスを、外部(unpkg)ではなく自分のGitHub上のファイルに強制固定
            const coreURL = await toBlobURL(`${loc}ffmpeg-core.js`, 'text/javascript');
            const workerURL = await toBlobURL(`${loc}worker.js`, 'text/javascript');
            // wasmはデータとして読み込むので外部でもOK
            const wasmURL = await toBlobURL('https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.wasm', 'application/wasm');

            await ffmpeg.load({
                coreURL: coreURL,
                workerURL: workerURL,
                wasmURL: wasmURL
            });

            status.innerText = "準備完了！音声をドロップしてください。";
        } catch (e) {
            console.error("FFmpeg Load Error:", e);
            status.innerText = "ロード失敗。キャッシュを消去してください。";
        }
    }

    init();

    // ドロップ＆変換処理
    const dropZone = document.getElementById('drop-zone');
    dropZone.ondragover = (e) => e.preventDefault();
    dropZone.ondrop = async (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) {
            status.innerText = "変換中...";
            await convert(file);
        }
    };

    async function convert(file) {
        const name = file.name.split('.').slice(0, -1).join('.');
        await ffmpeg.writeFile('input', await fetchFile(file));

        await ffmpeg.exec(['-i', 'input', '-c:a', 'aac', 'out.aac']);
        const aac = await ffmpeg.readFile('out.aac');

        await ffmpeg.exec(['-i', 'input', '-c:a', 'libvorbis', 'out.ogg']);
        const ogg = await ffmpeg.readFile('out.ogg');

        const zip = new JSZip();
        zip.file(`${name}.aac`, aac);
        zip.file(`${name}.ogg`, ogg);
        const blob = await zip.generateAsync({ type: "blob" });

        const url = URL.createObjectURL(blob);
        downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}_converted.zip`;
            a.click();
        };
        downloadBtn.style.display = 'block';
        status.innerText = "完了！";
    }
</script>
</body>
</html>
