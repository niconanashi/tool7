<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Audio Converter (niconanashi Edition)</title>
    <!-- 1. セキュリティ制限を解除するスクリプトを最優先で読み込む -->
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 50px; background: #f0f4f8; }
        .box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; width: 80%; max-width: 500px; }
        #drop-zone { border: 3px dashed #aaa; border-radius: 10px; padding: 40px 20px; cursor: pointer; transition: 0.3s; }
        #drop-zone.dragover { border-color: #007bff; background: #e7f1ff; }
        #status { margin-top: 20px; font-weight: bold; font-size: 14px; }
        #download-btn { margin-top: 20px; padding: 12px 24px; font-size: 16px; cursor: pointer; display: none; background: #28a745; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h1>音声変換 (AAC & OGG)</h1>
    <div id="drop-zone">ここに音声をドロップ</div>
    <div id="status">設定を確認中...</div>
    <button id="download-btn">ZIPファイルを保存</button>
</div>

<script type="module">
    import { FFmpeg } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/esm/index.js';
    import { fetchFile, toBlobURL } from 'https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js';

    const ffmpeg = new FFmpeg();
    const status = document.getElementById('status');
    const downloadBtn = document.getElementById('download-btn');

    async function init() {
        if (!self.crossOriginIsolated) {
            status.innerHTML = "<span style='color:red'>初期化中... 一度自動でリロードされます。<br>されない場合は手動でリロードしてください。</span>";
            return;
        }

        try {
            status.innerText = "FFmpegを準備しています...";
            
            // 現在のフォルダのパスを取得
            const loc = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            
            // 自分のリポジトリにあるファイルを Blob URL 化（セキュリティ回避の極意）
            const coreURL = await toBlobURL(`${loc}ffmpeg-core.js`, 'text/javascript');
            const workerURL = await toBlobURL(`${loc}worker.js`, 'text/javascript');
            const wasmURL = await toBlobURL('https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.wasm', 'application/wasm');

            await ffmpeg.load({ coreURL, workerURL, wasmURL });

            status.innerText = "準備完了！ファイルをドロップしてください。";
        } catch (e) {
            console.error(e);
            status.innerText = "ロード失敗。ブラウザのキャッシュをクリアして試してください。";
        }
    }
    init();

    // ドラッグ＆ドロップ処理
    const dropZone = document.getElementById('drop-zone');
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = async (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) convert(file);
    };

    async function convert(file) {
        downloadBtn.style.display = 'none';
        status.innerText = "変換中...";
        const name = file.name.split('.').slice(0, -1).join('.');

        try {
            await ffmpeg.writeFile('input', await fetchFile(file));
            
            status.innerText = "AACに変換中...";
            await ffmpeg.exec(['-i', 'input', '-c:a', 'aac', 'out.aac']);
            const aacData = await ffmpeg.readFile('out.aac');

            status.innerText = "OGGに変換中...";
            await ffmpeg.exec(['-i', 'input', '-c:a', 'libvorbis', 'out.ogg']);
            const oggData = await ffmpeg.readFile('out.ogg');

            status.innerText = "ZIPファイルを作成中...";
            const zip = new JSZip();
            zip.file(`${name}.aac`, aacData);
            zip.file(`${name}.ogg`, oggData);
            const blob = await zip.generateAsync({ type: "blob" });
            
            const url = URL.createObjectURL(blob);
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name}_converted.zip`;
                a.click();
            };
            downloadBtn.style.display = 'block';
            status.innerText = "完了！";
        } catch (err) {
            console.error(err);
            status.innerText = "変換エラー。コンソールを確認してください。";
        }
    }
</script>

</body>
</html>
