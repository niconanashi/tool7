<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Converter (Pages Fix)</title>
    <!-- 【最優先】セキュリティ規制を回避するスクリプト -->
    <script>
        if ('serviceWorker' in navigator) {
            // 現在のディレクトリ（./）に限定して登録
            navigator.serviceWorker.register('./coi-serviceworker.js', { scope: './' })
            .then(function(reg) {
                console.log('ServiceWorker 登録成功:', reg.scope);
            }).catch(function(err) {
                console.log('ServiceWorker 登録失敗:', err);
            });
        }
    </script>
    <script src="coi-serviceworker.js"></script>
    
    <!-- FFmpeg v0.11 -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background-color: #f4f7f9; }
        .card { background: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 90%; max-width: 480px; text-align: center; }
        #drop-zone { border: 3px dashed #e2e8f0; border-radius: 1rem; padding: 3rem 1rem; cursor: pointer; background: #f8fafc; transition: 0.3s; }
        #drop-zone.dragover { border-color: #4299e1; background: #ebf8ff; }
        #status { margin-top: 1.5rem; font-weight: bold; min-height: 3rem; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        #download-btn { margin-top: 1rem; padding: 0.8rem 2rem; font-size: 1rem; cursor: pointer; display: none; background: #48bb78; color: white; border: none; border-radius: 0.6rem; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h1>音声変換 (M4A & OGG)</h1>
    <div id="drop-zone">ここに音声をドロップ</div>
    <input type="file" id="file-input" style="display:none" accept="audio/*">
    <div id="status">準備中...</div>
    <button id="download-btn">ZIPファイルを保存する</button>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const status = document.getElementById('status');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const downloadBtn = document.getElementById('download-btn');
    
    const ffmpeg = createFFmpeg({
        log: true,
        corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
    });

    async function init() {
        if (!self.crossOriginIsolated) {
            status.innerHTML = "セキュリティ設定を適用中...<br>リロードをお待ちください。";
            return;
        }
        try {
            await ffmpeg.load();
            status.innerText = "準備完了！音声をドロップしてください。";
        } catch (e) {
            status.innerText = "ロード失敗。再読み込みしてください。";
        }
    }
    init();

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => { if(e.target.files[0]) process(e.target.files[0]); };
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files[0]) process(e.dataTransfer.files[0]);
    };

    async function process(file) {
        if (!ffmpeg.isLoaded()) return;
        if (!file.type.startsWith('audio/')) {
            status.innerHTML = "<span style='color:red'>エラー: 音声ファイル以外は処理できません。</span>";
            return;
        }
        const maxSize = 100 * 1024 * 1024; // 100MB
        if (file.size > maxSize) {
            status.innerHTML = "<span style='color:red'>エラー: ファイルが大きすぎます(100MBまで)。</span>";
            return;
        }
        downloadBtn.style.display = 'none';
        status.innerText = "変換中...";
        const name = file.name.split('.').slice(0, -1).join('.');

        try {
            ffmpeg.FS('writeFile', 'input', await fetchFile(file));

            status.innerText = "AAC(M4A)に変換中...";
            await ffmpeg.run('-i', 'input', '-c:a', 'aac', '-b:a', '128k', '-movflags', '+faststart', 'out.m4a');
            const aacData = ffmpeg.FS('readFile', 'out.m4a');

            status.innerText = "OGGに変換中...";
            await ffmpeg.run('-i', 'input', '-c:a', 'libvorbis', '-q:a', '4', 'out.ogg');
            const oggData = ffmpeg.FS('readFile', 'out.ogg');

            const zip = new JSZip();
            zip.file(`${name}.m4a`, aacData);
            zip.file(`${name}.ogg`, oggData);
            const blob = await zip.generateAsync({ type: "blob" });

            const url = URL.createObjectURL(blob);
            downloadBtn.onclick = () => {
                const a = document.createElement('a'); a.href = url;
                a.download = `${name}_converted.zip`; a.click();
            };
            status.innerText = "成功！";
            downloadBtn.style.display = 'block';
        } catch (err) {
            status.innerText = "エラーが発生しました。";
        }
    }
</script>
</body>
</html>
