<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Audio Converter (Fixed)</title>
    <!-- 1. サービスワーカーを一番最初に読み込む -->
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 50px; background: #f4f7f6; }
        #drop-zone { width: 80%; max-width: 500px; height: 150px; border: 3px dashed #aaa; border-radius: 15px; display: flex; align-items: center; justify-content: center; background: white; cursor: pointer; }
        #status { margin-top: 20px; font-weight: bold; text-align: center; }
        #download-btn { margin-top: 20px; padding: 12px 24px; font-size: 16px; cursor: pointer; display: none; background: #28a745; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>音声変換 (AAC & OGG)</h1>
    <div id="drop-zone">ここに音声をドロップ</div>
    <div id="status">FFmpegをロード中...</div>
    <button id="download-btn">ZIPファイルを保存</button>

    <script type="module">
        import { FFmpeg } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/esm/index.js';
        import { fetchFile, toBlobURL } from 'https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js';

        const status = document.getElementById('status');
        const downloadBtn = document.getElementById('download-btn');
        const ffmpeg = new FFmpeg();

        async function init() {
            // セキュリティ状態をコンソールに表示
            console.log("Cross-Origin Isolated:", self.crossOriginIsolated);

            try {
                // 現在のフォルダの絶対パスを取得
                const baseURL = window.location.origin + window.location.pathname.replace('index.html', '');
                
                // ファイルを明示的にBlob化して読み込む
                const coreURL = await toBlobURL(`${baseURL}ffmpeg-core.js`, 'text/javascript');
                const workerURL = await toBlobURL(`${baseURL}worker.js`, 'text/javascript');
                const wasmURL = await toBlobURL('https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.wasm', 'application/wasm');

                console.log("Loading FFmpeg with:", { coreURL, workerURL, wasmURL });

                await ffmpeg.load({
                    coreURL,
                    workerURL,
                    wasmURL
                });

                status.innerText = "準備完了！ファイルをドロップしてください。";
            } catch (e) {
                console.error("Load Error:", e);
                status.innerHTML = "ロード失敗。<br>ブラウザのキャッシュをクリアして再試行してください。";
            }
        }

        init();

        // ドロップ処理
        const dropZone = document.getElementById('drop-zone');
        dropZone.ondragover = (e) => e.preventDefault();
        dropZone.ondrop = async (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) {
                status.innerText = "変換中... 数分かかる場合があります。";
                await convert(file);
            }
        };

        async function convert(file) {
            const name = file.name.split('.').slice(0, -1).join('.');
            await ffmpeg.writeFile('input', await fetchFile(file));

            await ffmpeg.exec(['-i', 'input', '-c:a', 'aac', 'out.aac']);
            const aac = await ffmpeg.readFile('out.aac');

            await ffmpeg.exec(['-i', 'input', '-c:a', 'libvorbis', 'out.ogg']);
            const ogg = await ffmpeg.readFile('out.ogg');

            const zip = new JSZip();
            zip.file(`${name}.aac`, aac);
            zip.file(`${name}.ogg`, ogg);
            const blob = await zip.generateAsync({ type: "blob" });

            const url = URL.createObjectURL(blob);
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name}_converted.zip`;
                a.click();
            };
            downloadBtn.style.display = 'block';
            status.innerText = "完了しました！";
        }
    </script>
</body>
</html>
